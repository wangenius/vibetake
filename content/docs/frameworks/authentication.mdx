---
title: authentication
---


# BetterAuth è®¤è¯ç³»ç»Ÿ

BetterAuth æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ TypeScript è®¤è¯åº“ï¼Œä¸º Vibe Template æä¾›äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯è§£å†³æ–¹æ¡ˆã€‚æœ¬æ–‡æ¡£å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®å’Œä½¿ç”¨ BetterAuth è®¤è¯ç³»ç»Ÿã€‚

## æ¦‚è¿°

Vibe Template é›†æˆäº† BetterAuth è®¤è¯ç³»ç»Ÿï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

- ğŸ“§ é‚®ç®±å¯†ç è®¤è¯
- ğŸ” ä¼šè¯ç®¡ç†
- ğŸ›¡ï¸ å®‰å…¨çš„å¯†ç å¤„ç†
- ğŸ“± å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è®¤è¯çŠ¶æ€åŒæ­¥
- ğŸ—„ï¸ ä¸ Drizzle ORM çš„æ— ç¼é›†æˆ

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    A[å®¢æˆ·ç«¯] --> B[Auth Client]
    B --> C[API Routes]
    C --> D[Better Auth Core]
    D --> E[Drizzle Adapter]
    E --> F[æ•°æ®åº“]

    subgraph "è®¤è¯æµç¨‹"
        G[ç™»å½•/æ³¨å†Œ] --> H[éªŒè¯å‡­æ®]
        H --> I[åˆ›å»ºä¼šè¯]
        I --> J[è¿”å›ç”¨æˆ·ä¿¡æ¯]
    end
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

é¦–å…ˆï¼Œç¡®ä¿åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®äº†å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# Better Auth é…ç½®
BETTER_AUTH_URL=http://localhost:3000
NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://postgres:password@localhost:5432/your_database
```

### 2. åŸºæœ¬ä½¿ç”¨

åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨è®¤è¯åŠŸèƒ½ï¼š

```tsx
"use client";
import { useSession, signIn, signOut } from "@/services/userauth/auth-client";

export function AuthExample() {
  const { data: session, isPending } = useSession();

  if (isPending) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (session) {
    return (
      <div>
        <p>æ¬¢è¿, {session.user.name}!</p>
        <button onClick={() => signOut()}>é€€å‡ºç™»å½•</button>
      </div>
    );
  }

  return (
    <button
      onClick={() =>
        signIn.email({
          email: "user@example.com",
          password: "password",
        })
      }
    >
      ç™»å½•
    </button>
  );
}
```

## æ ¸å¿ƒé…ç½®

### æœåŠ¡ç«¯é…ç½®

BetterAuth çš„æ ¸å¿ƒé…ç½®ä½äº `src/services/userauth/auth.ts`ï¼š

```typescript
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { db } from "@/services/database/client";
import * as schema from "@/services/database/schema";

export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:3000",
  database: drizzleAdapter(db, {
    provider: "sqlite", // æˆ– "postgresql"
    schema,
  }),
  emailAndPassword: {
    enabled: true,
  },
});
```

### å®¢æˆ·ç«¯é…ç½®

å®¢æˆ·ç«¯é…ç½®ä½äº `src/services/userauth/auth-client.ts`ï¼š

```typescript
"use client";
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_BETTER_AUTH_URL || "http://localhost:3000",
});

export const { signUp, signIn, signOut, useSession } = authClient;
```

## æ•°æ®åº“æ¨¡å¼

BetterAuth éœ€è¦ä»¥ä¸‹æ•°æ®åº“è¡¨ç»“æ„ï¼ˆä½äº `src/services/database/schema.ts`ï¼‰ï¼š

### ç”¨æˆ·è¡¨ (user)

```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  emailVerified: boolean("email_verified").default(false).notNull(),
  image: text("image"),
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

### è´¦æˆ·è¡¨ (account)

```typescript
export const account = pgTable("account", {
  id: text("id").primaryKey(),
  userId: text("user_id")
    .notNull()
    .references(() => user.id),
  accountId: text("account_id").notNull(),
  providerId: text("provider_id").notNull(),
  accessToken: text("access_token"),
  refreshToken: text("refresh_token"),
  password: text("password"), // ç”¨äºé‚®ç®±å¯†ç è®¤è¯
  // ... å…¶ä»–å­—æ®µ
});
```

### ä¼šè¯è¡¨ (session)

```typescript
export const session = pgTable("session", {
  id: text("id").primaryKey(),
  userId: text("user_id")
    .notNull()
    .references(() => user.id),
  token: text("token").notNull(),
  expiresAt: timestamp("expires_at").notNull(),
  ipAddress: text("ip_address"),
  userAgent: text("user_agent"),
  // ... å…¶ä»–å­—æ®µ
});
```

## ç”¨æˆ·æ³¨å†Œæµç¨‹

### 1. æ³¨å†Œè¡¨å•ç»„ä»¶

```tsx
"use client";
import { useState } from "react";
import { signUp } from "@/services/userauth/auth-client";
import { toast } from "sonner";

export function RegisterForm() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const result = await signUp.email({
        email,
        password,
        name,
        callbackURL: "/login",
      });

      if (result.error) {
        toast.error(result.error.message);
      } else {
        toast.success("æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚");
      }
    } catch (error) {
      toast.error("æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="text"
        placeholder="å§“å"
        value={name}
        onChange={(e) => setName(e.target.value)}
        required
      />
      <input
        type="email"
        placeholder="é‚®ç®±"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        required
      />
      <input
        type="password"
        placeholder="å¯†ç "
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        required
      />
      <button type="submit" disabled={loading}>
        {loading ? "æ³¨å†Œä¸­..." : "æ³¨å†Œ"}
      </button>
    </form>
  );
}
```

### 2. æ³¨å†Œæµç¨‹è¯´æ˜

1. **ç”¨æˆ·è¾“å…¥ä¿¡æ¯**ï¼šå§“åã€é‚®ç®±ã€å¯†ç 
2. **å®¢æˆ·ç«¯éªŒè¯**ï¼šåŸºæœ¬çš„è¡¨å•éªŒè¯
3. **å‘é€æ³¨å†Œè¯·æ±‚**ï¼šè°ƒç”¨ `signUp.email()` æ–¹æ³•
4. **æœåŠ¡ç«¯å¤„ç†**ï¼š
   - éªŒè¯é‚®ç®±æ ¼å¼å’Œå¯†ç å¼ºåº¦
   - æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
   - åˆ›å»ºç”¨æˆ·è®°å½•
   - ç”ŸæˆåŠ å¯†å¯†ç 
5. **è¿”å›ç»“æœ**ï¼šæˆåŠŸæˆ–é”™è¯¯ä¿¡æ¯

## ç”¨æˆ·ç™»å½•æµç¨‹

### 1. ç™»å½•è¡¨å•ç»„ä»¶

```tsx
"use client";
import { useState } from "react";
import { signIn } from "@/services/userauth/auth-client";

export function LoginForm() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setLoading(true);

    try {
      await signIn.email({
        email,
        password,
        callbackURL: "/",
      });
    } catch (err: any) {
      setError(err?.message ?? "ç™»å½•å¤±è´¥");
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        placeholder="é‚®ç®±"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        required
      />
      <input
        type="password"
        placeholder="å¯†ç "
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        required
      />
      <button type="submit" disabled={loading}>
        {loading ? "ç™»å½•ä¸­..." : "ç™»å½•"}
      </button>
      {error && <p className="error">{error}</p>}
    </form>
  );
}
```

### 2. ç™»å½•æµç¨‹è¯´æ˜

1. **ç”¨æˆ·è¾“å…¥å‡­æ®**ï¼šé‚®ç®±å’Œå¯†ç 
2. **å®¢æˆ·ç«¯éªŒè¯**ï¼šåŸºæœ¬çš„è¡¨å•éªŒè¯
3. **å‘é€ç™»å½•è¯·æ±‚**ï¼šè°ƒç”¨ `signIn.email()` æ–¹æ³•
4. **æœåŠ¡ç«¯éªŒè¯**ï¼š
   - æŸ¥æ‰¾ç”¨æˆ·è®°å½•
   - éªŒè¯å¯†ç 
   - åˆ›å»ºä¼šè¯
   - è®¾ç½®è®¤è¯ Cookie
5. **é‡å®šå‘**ï¼šç™»å½•æˆåŠŸåè·³è½¬åˆ°æŒ‡å®šé¡µé¢

## ä¼šè¯ç®¡ç†

### 1. ä¼šè¯çŠ¶æ€æ£€æŸ¥

```tsx
"use client";
import { useSession } from "@/services/userauth/auth-client";

export function SessionExample() {
  const { data: session, isPending, error } = useSession();

  if (isPending) {
    return <div>æ£€æŸ¥ç™»å½•çŠ¶æ€...</div>;
  }

  if (error) {
    return <div>ä¼šè¯é”™è¯¯: {error.message}</div>;
  }

  if (session) {
    return (
      <div>
        <h2>ç”¨æˆ·ä¿¡æ¯</h2>
        <p>ID: {session.user.id}</p>
        <p>å§“å: {session.user.name}</p>
        <p>é‚®ç®±: {session.user.email}</p>
        <p>é‚®ç®±å·²éªŒè¯: {session.user.emailVerified ? "æ˜¯" : "å¦"}</p>
      </div>
    );
  }

  return <div>æœªç™»å½•</div>;
}
```

### 2. æœåŠ¡ç«¯ä¼šè¯éªŒè¯

```typescript
import { auth } from "@/services/userauth/auth";
import { headers } from "next/headers";

export async function getServerSession() {
  const session = await auth.api.getSession({
    headers: headers(),
  });

  return session;
}

// åœ¨ Server Component ä¸­ä½¿ç”¨
export default async function ProtectedPage() {
  const session = await getServerSession();

  if (!session) {
    redirect("/login");
  }

  return (
    <div>
      <h1>å—ä¿æŠ¤çš„é¡µé¢</h1>
      <p>æ¬¢è¿, {session.user.name}!</p>
    </div>
  );
}
```

## æƒé™ç®¡ç†

### 1. è·¯ç”±ä¿æŠ¤

åˆ›å»ºä¸€ä¸ªé«˜é˜¶ç»„ä»¶æ¥ä¿æŠ¤éœ€è¦è®¤è¯çš„é¡µé¢ï¼š

```tsx
"use client";
import { useSession } from "@/services/userauth/auth-client";
import { useRouter } from "next/navigation";
import { useEffect } from "react";

export function withAuth<P extends object>(Component: React.ComponentType<P>) {
  return function AuthenticatedComponent(props: P) {
    const { data: session, isPending } = useSession();
    const router = useRouter();

    useEffect(() => {
      if (!isPending && !session) {
        router.push("/login");
      }
    }, [session, isPending, router]);

    if (isPending) {
      return <div>éªŒè¯ä¸­...</div>;
    }

    if (!session) {
      return null;
    }

    return <Component {...props} />;
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const ProtectedPage = withAuth(() => {
  return <div>è¿™æ˜¯å—ä¿æŠ¤çš„é¡µé¢</div>;
});
```

### 2. ä¸­é—´ä»¶ä¿æŠ¤

åˆ›å»º `middleware.ts` æ–‡ä»¶æ¥ä¿æŠ¤ API è·¯ç”±ï¼š

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/services/userauth/auth";

export async function middleware(request: NextRequest) {
  // æ£€æŸ¥æ˜¯å¦æ˜¯å—ä¿æŠ¤çš„è·¯ç”±
  if (request.nextUrl.pathname.startsWith("/api/protected")) {
    const session = await auth.api.getSession({
      headers: request.headers,
    });

    if (!session) {
      return NextResponse.json({ error: "æœªæˆæƒè®¿é—®" }, { status: 401 });
    }
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/api/protected/:path*"],
};
```

## API è·¯ç”±é›†æˆ

### 1. è®¤è¯ API è·¯ç”±

BetterAuth è‡ªåŠ¨å¤„ç†è®¤è¯ç›¸å…³çš„ API è·¯ç”±ï¼Œä½äº `src/app/api/auth/[...all]/route.ts`ï¼š

```typescript
import { toNextJsHandler } from "better-auth/next-js";
import { auth } from "@/services/userauth/auth";

export const { GET, POST } = toNextJsHandler(auth);
```

è¿™ä¸ªè·¯ç”±å¤„ç†ä»¥ä¸‹ç«¯ç‚¹ï¼š

- `POST /api/auth/sign-in/email` - é‚®ç®±ç™»å½•
- `POST /api/auth/sign-up/email` - é‚®ç®±æ³¨å†Œ
- `POST /api/auth/sign-out` - é€€å‡ºç™»å½•
- `GET /api/auth/session` - è·å–ä¼šè¯ä¿¡æ¯

### 2. è‡ªå®šä¹‰ API è·¯ç”±

åˆ›å»ºéœ€è¦è®¤è¯çš„ API è·¯ç”±ï¼š

```typescript
// app/api/protected/profile/route.ts
import { auth } from "@/services/userauth/auth";
import { NextRequest, NextResponse } from "next/server";

export async function GET(request: NextRequest) {
  const session = await auth.api.getSession({
    headers: request.headers,
  });

  if (!session) {
    return NextResponse.json({ error: "æœªæˆæƒè®¿é—®" }, { status: 401 });
  }

  // è¿”å›ç”¨æˆ·ä¿¡æ¯
  return NextResponse.json({
    user: session.user,
  });
}
```

## é”™è¯¯å¤„ç†

### 1. å¸¸è§é”™è¯¯ç±»å‹

```typescript
interface AuthError {
  message: string;
  code: string;
}

// å¸¸è§é”™è¯¯ä»£ç 
const AUTH_ERRORS = {
  INVALID_CREDENTIALS: "å‡­æ®æ— æ•ˆ",
  USER_NOT_FOUND: "ç”¨æˆ·ä¸å­˜åœ¨",
  EMAIL_ALREADY_EXISTS: "é‚®ç®±å·²å­˜åœ¨",
  WEAK_PASSWORD: "å¯†ç å¼ºåº¦ä¸å¤Ÿ",
  SESSION_EXPIRED: "ä¼šè¯å·²è¿‡æœŸ",
} as const;
```

### 2. é”™è¯¯å¤„ç†ç¤ºä¾‹

```tsx
"use client";
import { useState } from "react";
import { signIn } from "@/services/userauth/auth-client";

export function LoginWithErrorHandling() {
  const [error, setError] = useState<string | null>(null);

  const handleLogin = async (email: string, password: string) => {
    try {
      setError(null);
      await signIn.email({ email, password });
    } catch (err: any) {
      // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
      switch (err.code) {
        case "INVALID_CREDENTIALS":
          setError("é‚®ç®±æˆ–å¯†ç é”™è¯¯");
          break;
        case "USER_NOT_FOUND":
          setError("ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ");
          break;
        default:
          setError("ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
      }
    }
  };

  return (
    <div>
      {error && <div className="error-message">{error}</div>}
      {/* ç™»å½•è¡¨å• */}
    </div>
  );
}
```

## æœ€ä½³å®è·µ

### 1. å®‰å…¨é…ç½®

```typescript
// ç”Ÿäº§ç¯å¢ƒé…ç½®
export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL,
  database: drizzleAdapter(db, {
    provider: "postgresql",
    schema,
  }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 8,
    maxPasswordLength: 128,
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 å¤©
    updateAge: 60 * 60 * 24, // 1 å¤©
  },
  advanced: {
    crossSubDomainCookies: {
      enabled: true,
      domain: ".yourdomain.com",
    },
  },
});
```

### 2. å¯†ç å®‰å…¨

- ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥ï¼ˆæœ€å°‘ 8 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
- å®æ–½å¯†ç é‡è¯•é™åˆ¶
- è€ƒè™‘æ·»åŠ åŒå› ç´ è®¤è¯

### 3. ä¼šè¯ç®¡ç†

- è®¾ç½®åˆç†çš„ä¼šè¯è¿‡æœŸæ—¶é—´
- å®æ–½ä¼šè¯åˆ·æ–°æœºåˆ¶
- åœ¨æ•æ„Ÿæ“ä½œå‰é‡æ–°éªŒè¯

### 4. ç›‘æ§å’Œæ—¥å¿—

```typescript
// æ·»åŠ è®¤è¯äº‹ä»¶ç›‘å¬
auth.on("session.created", (session) => {
  console.log("ç”¨æˆ·ç™»å½•:", session.user.email);
});

auth.on("session.deleted", (session) => {
  console.log("ç”¨æˆ·é€€å‡º:", session.user.email);
});
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¼šè¯ä¸æŒä¹…**

   - æ£€æŸ¥ Cookie è®¾ç½®
   - ç¡®è®¤åŸŸåé…ç½®æ­£ç¡®

2. **ç™»å½•åç«‹å³é€€å‡º**

   - æ£€æŸ¥æ•°æ®åº“è¿æ¥
   - éªŒè¯ä¼šè¯è¡¨ç»“æ„

3. **CORS é”™è¯¯**
   - é…ç½®æ­£ç¡®çš„ `baseURL`
   - æ£€æŸ¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ URL ä¸€è‡´æ€§

### è°ƒè¯•æŠ€å·§

```typescript
// å¯ç”¨è°ƒè¯•æ¨¡å¼
export const auth = betterAuth({
  // ... å…¶ä»–é…ç½®
  logger: {
    level: "debug",
  },
});
```

## æ‰©å±•åŠŸèƒ½

### 1. ç¤¾äº¤ç™»å½•

è™½ç„¶å½“å‰æ¨¡æ¿ä¸»è¦ä½¿ç”¨é‚®ç®±å¯†ç è®¤è¯ï¼Œä½† BetterAuth æ”¯æŒå¤šç§ç¤¾äº¤ç™»å½•ï¼š

```typescript
// æ·»åŠ  Google ç™»å½•
export const auth = betterAuth({
  // ... å…¶ä»–é…ç½®
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
  },
});
```

### 2. é‚®ç®±éªŒè¯

```typescript
export const auth = betterAuth({
  // ... å…¶ä»–é…ç½®
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
  },
  emailVerification: {
    sendOnSignUp: true,
    autoSignInAfterVerification: true,
  },
});
```

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ åº”è¯¥èƒ½å¤Ÿå®Œå…¨ç†è§£å’Œä½¿ç”¨ Vibe Template ä¸­çš„ BetterAuth è®¤è¯ç³»ç»Ÿã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ [BetterAuth å®˜æ–¹æ–‡æ¡£](https://www.better-auth.com/docs) æˆ–åœ¨é¡¹ç›®ä»“åº“ä¸­æå‡º Issueã€‚
