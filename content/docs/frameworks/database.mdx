---
title: database
---

# æ•°æ®åº“æ“ä½œæŒ‡å—

Vibetake ä½¿ç”¨ Drizzle ORM ä¸ PostgreSQL æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œã€‚æœ¬æ–‡æ¡£å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®å’Œä½¿ç”¨æ•°æ®åº“ç³»ç»Ÿã€‚

## æ¦‚è¿°

æ•°æ®åº“æŠ€æœ¯æ ˆåŒ…æ‹¬ï¼š

- ğŸ—„ï¸ **PostgreSQL** - ä¸»æ•°æ®åº“
- ğŸ”§ **Drizzle ORM** - TypeScript ORM
- ğŸš€ **Drizzle Kit** - æ•°æ®åº“è¿ç§»å·¥å…·
- ğŸ”— **postgres.js** - PostgreSQL å®¢æˆ·ç«¯
- â˜ï¸ **Supabase** - æ¨èçš„äº‘æ•°æ®åº“æœåŠ¡

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    A[åº”ç”¨ç¨‹åº] --> B[Drizzle ORM]
    B --> C[postgres.js å®¢æˆ·ç«¯]
    C --> D[PostgreSQL æ•°æ®åº“]
    
    E[Drizzle Kit] --> F[è¿ç§»æ–‡ä»¶]
    F --> D
    
    subgraph "æ•°æ®åº“å±‚"
        G[Schema å®šä¹‰] --> H[ç±»å‹ç”Ÿæˆ]
        H --> I[æŸ¥è¯¢æ„å»ºå™¨]
        I --> J[SQL æ‰§è¡Œ]
    end
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ•°æ®åº“è¿æ¥ï¼š

```bash
# PostgreSQL æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql://postgres:password@localhost:5432/your_database

# æˆ–è€…ä½¿ç”¨ Supabase
DATABASE_URL=postgresql://postgres:[password]@[host]:5432/postgres
```

### 2. åŸºæœ¬ä½¿ç”¨

```typescript
import { db } from "@/services/database/client";
import { user } from "@/services/database/schema";
import { eq } from "drizzle-orm";

// æŸ¥è¯¢ç”¨æˆ·
const users = await db.select().from(user);

// æ ¹æ® ID æŸ¥è¯¢ç”¨æˆ·
const userById = await db
  .select()
  .from(user)
  .where(eq(user.id, "user-id"));

// åˆ›å»ºç”¨æˆ·
const newUser = await db
  .insert(user)
  .values({
    id: "new-user-id",
    name: "å¼ ä¸‰",
    email: "zhangsan@example.com",
  })
  .returning();
```

## æ•°æ®åº“é…ç½®

### 1. å®¢æˆ·ç«¯é…ç½®

æ•°æ®åº“å®¢æˆ·ç«¯é…ç½®ä½äº `src/services/database/client.ts`ï¼š

```typescript
import dotenv from "dotenv";
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import * as schema from "./schema";

dotenv.config();

const databaseUrl =
  process.env.DATABASE_URL ||
  "postgresql://postgres:password@localhost:5432/postgres";

const client = postgres(databaseUrl);
const db = drizzle(client, { schema });

export { db };
```

### 2. Drizzle Kit é…ç½®

Drizzle Kit é…ç½®ä½äº `drizzle.config.ts`ï¼š

```typescript
import { defineConfig } from "drizzle-kit";
import { config } from "dotenv";

config();

export default defineConfig({
  schema: "./src/services/database/schema.ts",
  out: "./drizzle/postgres",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

## æ•°æ®åº“æ¨¡å¼

### 1. ç”¨æˆ·è¡¨ (user)

```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  emailVerified: boolean("email_verified").default(false).notNull(),
  image: text("image"),
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

**å­—æ®µè¯´æ˜ï¼š**
- `id`: ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦
- `name`: ç”¨æˆ·å§“å
- `email`: ç”¨æˆ·é‚®ç®±ï¼ˆå¿…å¡«ï¼Œå”¯ä¸€ï¼‰
- `emailVerified`: é‚®ç®±éªŒè¯çŠ¶æ€
- `image`: ç”¨æˆ·å¤´åƒ URL
- `createdAt`: åˆ›å»ºæ—¶é—´
- `updatedAt`: æ›´æ–°æ—¶é—´

### 2. è´¦æˆ·è¡¨ (account)

```typescript
export const account = pgTable("account", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id),
  accountId: text("account_id").notNull(),
  providerId: text("provider_id").notNull(),
  accessToken: text("access_token"),
  refreshToken: text("refresh_token"),
  accessTokenExpiresAt: timestamp("access_token_expires_at"),
  refreshTokenExpiresAt: timestamp("refresh_token_expires_at"),
  scope: text("scope"),
  idToken: text("id_token"),
  password: text("password"), // ç”¨äºé‚®ç®±å¯†ç è®¤è¯
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

### 3. ä¼šè¯è¡¨ (session)

```typescript
export const session = pgTable("session", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id),
  token: text("token").notNull(),
  expiresAt: timestamp("expires_at").notNull(),
  ipAddress: text("ip_address"),
  userAgent: text("user_agent"),
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

### 4. éªŒè¯è¡¨ (verification)

```typescript
export const verification = pgTable("verification", {
  id: text("id").primaryKey(),
  identifier: text("identifier").notNull(),
  value: text("value").notNull(),
  expiresAt: timestamp("expires_at").notNull(),
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

## åŸºæœ¬ CRUD æ“ä½œ

### 1. åˆ›å»º (Create)

```typescript
import { db } from "@/services/database/client";
import { user } from "@/services/database/schema";

// æ’å…¥å•ä¸ªç”¨æˆ·
const newUser = await db
  .insert(user)
  .values({
    id: crypto.randomUUID(),
    name: "å¼ ä¸‰",
    email: "zhangsan@example.com",
    emailVerified: false,
  })
  .returning();

// æ’å…¥å¤šä¸ªç”¨æˆ·
const newUsers = await db
  .insert(user)
  .values([
    {
      id: crypto.randomUUID(),
      name: "æå››",
      email: "lisi@example.com",
    },
    {
      id: crypto.randomUUID(),
      name: "ç‹äº”",
      email: "wangwu@example.com",
    },
  ])
  .returning();

console.log("åˆ›å»ºçš„ç”¨æˆ·:", newUsers);
```

### 2. æŸ¥è¯¢ (Read)

```typescript
import { db } from "@/services/database/client";
import { user } from "@/services/database/schema";
import { eq, like, and, or, desc, asc } from "drizzle-orm";

// æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
const allUsers = await db.select().from(user);

// æ ¹æ® ID æŸ¥è¯¢
const userById = await db
  .select()
  .from(user)
  .where(eq(user.id, "user-id"))
  .limit(1);

// æ ¹æ®é‚®ç®±æŸ¥è¯¢
const userByEmail = await db
  .select()
  .from(user)
  .where(eq(user.email, "zhangsan@example.com"));

// æ¨¡ç³ŠæŸ¥è¯¢
const usersWithName = await db
  .select()
  .from(user)
  .where(like(user.name, "%å¼ %"));

// å¤åˆæ¡ä»¶æŸ¥è¯¢
const verifiedUsers = await db
  .select()
  .from(user)
  .where(
    and(
      eq(user.emailVerified, true),
      like(user.email, "%@gmail.com")
    )
  );

// æ’åºå’Œåˆ†é¡µ
const paginatedUsers = await db
  .select()
  .from(user)
  .orderBy(desc(user.createdAt))
  .limit(10)
  .offset(0);
```

### 3. æ›´æ–° (Update)

```typescript
import { db } from "@/services/database/client";
import { user } from "@/services/database/schema";
import { eq } from "drizzle-orm";

// æ›´æ–°å•ä¸ªç”¨æˆ·
const updatedUser = await db
  .update(user)
  .set({
    name: "å¼ ä¸‰ä¸°",
    emailVerified: true,
    updatedAt: new Date(),
  })
  .where(eq(user.id, "user-id"))
  .returning();

// æ‰¹é‡æ›´æ–°
const updatedUsers = await db
  .update(user)
  .set({
    emailVerified: true,
    updatedAt: new Date(),
  })
  .where(eq(user.emailVerified, false))
  .returning();

console.log("æ›´æ–°çš„ç”¨æˆ·:", updatedUsers);
```

### 4. åˆ é™¤ (Delete)

```typescript
import { db } from "@/services/database/client";
import { user } from "@/services/database/schema";
import { eq, lt } from "drizzle-orm";

// åˆ é™¤å•ä¸ªç”¨æˆ·
const deletedUser = await db
  .delete(user)
  .where(eq(user.id, "user-id"))
  .returning();

// æ‰¹é‡åˆ é™¤ï¼ˆåˆ é™¤30å¤©å‰åˆ›å»ºçš„æœªéªŒè¯ç”¨æˆ·ï¼‰
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const deletedUsers = await db
  .delete(user)
  .where(
    and(
      eq(user.emailVerified, false),
      lt(user.createdAt, thirtyDaysAgo)
    )
  )
  .returning();

console.log("åˆ é™¤çš„ç”¨æˆ·:", deletedUsers);
```

## é«˜çº§æŸ¥è¯¢

### 1. å…³è”æŸ¥è¯¢

```typescript
import { db } from "@/services/database/client";
import { user, account, session } from "@/services/database/schema";
import { eq } from "drizzle-orm";

// æŸ¥è¯¢ç”¨æˆ·åŠå…¶è´¦æˆ·ä¿¡æ¯
const usersWithAccounts = await db
  .select({
    user: user,
    account: account,
  })
  .from(user)
  .leftJoin(account, eq(user.id, account.userId));

// æŸ¥è¯¢ç”¨æˆ·åŠå…¶æ´»è·ƒä¼šè¯
const usersWithSessions = await db
  .select({
    userId: user.id,
    userName: user.name,
    userEmail: user.email,
    sessionId: session.id,
    sessionToken: session.token,
    sessionExpiresAt: session.expiresAt,
  })
  .from(user)
  .innerJoin(session, eq(user.id, session.userId))
  .where(gt(session.expiresAt, new Date()));
```

### 2. èšåˆæŸ¥è¯¢

```typescript
import { db } from "@/services/database/client";
import { user, session } from "@/services/database/schema";
import { count, sql } from "drizzle-orm";

// ç»Ÿè®¡ç”¨æˆ·æ•°é‡
const userCount = await db
  .select({ count: count() })
  .from(user);

// ç»Ÿè®¡å·²éªŒè¯ç”¨æˆ·æ•°é‡
const verifiedUserCount = await db
  .select({ count: count() })
  .from(user)
  .where(eq(user.emailVerified, true));

// æŒ‰æœˆç»Ÿè®¡ç”¨æˆ·æ³¨å†Œæ•°é‡
const monthlyRegistrations = await db
  .select({
    month: sql<string>`DATE_TRUNC('month', ${user.createdAt})`,
    count: count(),
  })
  .from(user)
  .groupBy(sql`DATE_TRUNC('month', ${user.createdAt})`)
  .orderBy(sql`DATE_TRUNC('month', ${user.createdAt})`);
```

### 3. äº‹åŠ¡å¤„ç†

```typescript
import { db } from "@/services/database/client";
import { user, account } from "@/services/database/schema";

// äº‹åŠ¡ç¤ºä¾‹ï¼šåˆ›å»ºç”¨æˆ·å’Œè´¦æˆ·
async function createUserWithAccount(userData: {
  name: string;
  email: string;
  password: string;
}) {
  return await db.transaction(async (tx) => {
    // åˆ›å»ºç”¨æˆ·
    const [newUser] = await tx
      .insert(user)
      .values({
        id: crypto.randomUUID(),
        name: userData.name,
        email: userData.email,
        emailVerified: false,
      })
      .returning();

    // åˆ›å»ºè´¦æˆ·
    const [newAccount] = await tx
      .insert(account)
      .values({
        id: crypto.randomUUID(),
        userId: newUser.id,
        accountId: newUser.id,
        providerId: "email",
        password: userData.password, // å®é™…åº”ç”¨ä¸­éœ€è¦åŠ å¯†
      })
      .returning();

    return { user: newUser, account: newAccount };
  });
}

// ä½¿ç”¨äº‹åŠ¡
try {
  const result = await createUserWithAccount({
    name: "æ–°ç”¨æˆ·",
    email: "newuser@example.com",
    password: "hashedPassword",
  });
  console.log("ç”¨æˆ·åˆ›å»ºæˆåŠŸ:", result);
} catch (error) {
  console.error("ç”¨æˆ·åˆ›å»ºå¤±è´¥:", error);
}
```

## æ•°æ®åº“è¿ç§»

### 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶

å½“ä½ ä¿®æ”¹äº† schema æ–‡ä»¶åï¼Œéœ€è¦ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼š

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
npm run generate

# æˆ–è€…ä½¿ç”¨ drizzle-kit ç›´æ¥
npx drizzle-kit generate
```

### 2. æ‰§è¡Œè¿ç§»

```bash
# æ‰§è¡Œè¿ç§»
npm run migrate

# æˆ–è€…ä½¿ç”¨ drizzle-kit ç›´æ¥
npx drizzle-kit migrate
```

### 3. æ¨é€åˆ°æ•°æ®åº“

å¯¹äºå¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ç›´æ¥æ¨é€ schema åˆ°æ•°æ®åº“ï¼š

```bash
# ç›´æ¥æ¨é€ schemaï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
npm run db:push

# æˆ–è€…ä½¿ç”¨ drizzle-kit ç›´æ¥
npx drizzle-kit push
```

### 4. è¿ç§»æœ€ä½³å®è·µ

```typescript
// æ·»åŠ æ–°å­—æ®µæ—¶ä½¿ç”¨é»˜è®¤å€¼
export const user = pgTable("user", {
  // ... ç°æœ‰å­—æ®µ
  
  // æ–°å¢å­—æ®µï¼Œæä¾›é»˜è®¤å€¼
  phoneNumber: text("phone_number").default(""),
  isActive: boolean("is_active").default(true).notNull(),
});

// é‡å‘½åå­—æ®µæ—¶çš„è¿ç§»ç­–ç•¥
// 1. æ·»åŠ æ–°å­—æ®µ
// 2. æ•°æ®è¿ç§»
// 3. åˆ é™¤æ—§å­—æ®µ
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_email ON user(email);
CREATE INDEX idx_user_created_at ON user(created_at);
CREATE INDEX idx_session_user_id ON session(user_id);
CREATE INDEX idx_session_expires_at ON session(expires_at);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ select æŒ‡å®šéœ€è¦çš„å­—æ®µ
const users = await db
  .select({
    id: user.id,
    name: user.name,
    email: user.email,
  })
  .from(user);

// ä½¿ç”¨ limit é™åˆ¶ç»“æœæ•°é‡
const recentUsers = await db
  .select()
  .from(user)
  .orderBy(desc(user.createdAt))
  .limit(20);

// ä½¿ç”¨ exists è¿›è¡Œå­˜åœ¨æ€§æ£€æŸ¥
const hasActiveSession = await db
  .select({ exists: sql`1` })
  .from(session)
  .where(
    and(
      eq(session.userId, userId),
      gt(session.expiresAt, new Date())
    )
  )
  .limit(1);
```

### 3. è¿æ¥æ± é…ç½®

```typescript
// é…ç½®è¿æ¥æ± 
const client = postgres(databaseUrl, {
  max: 20, // æœ€å¤§è¿æ¥æ•°
  idle_timeout: 20, // ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  connect_timeout: 10, // è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
});
```

## æ•°æ®éªŒè¯

### 1. ä½¿ç”¨ Zod è¿›è¡Œæ•°æ®éªŒè¯

```typescript
import { z } from "zod";

// ç”¨æˆ·æ•°æ®éªŒè¯ schema
export const userSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(100),
  email: z.string().email(),
  emailVerified: z.boolean().default(false),
  image: z.string().url().optional(),
});

// åˆ›å»ºç”¨æˆ·æ—¶çš„éªŒè¯
export const createUserSchema = userSchema.omit({ 
  id: true,
  emailVerified: true,
});

// æ›´æ–°ç”¨æˆ·æ—¶çš„éªŒè¯
export const updateUserSchema = userSchema.partial().omit({ 
  id: true 
});

// ä½¿ç”¨ç¤ºä¾‹
async function createUser(data: unknown) {
  const validatedData = createUserSchema.parse(data);
  
  return await db
    .insert(user)
    .values({
      id: crypto.randomUUID(),
      ...validatedData,
    })
    .returning();
}
```

### 2. æ•°æ®åº“çº¦æŸ

```typescript
// åœ¨ schema ä¸­å®šä¹‰çº¦æŸ
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(), // å”¯ä¸€çº¦æŸ
  emailVerified: boolean("email_verified").default(false).notNull(),
  createdAt: timestamp("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
}, (table) => ({
  // å¤åˆç´¢å¼•
  emailCreatedAtIdx: index("email_created_at_idx")
    .on(table.email, table.createdAt),
}));
```

## é”™è¯¯å¤„ç†

### 1. å¸¸è§é”™è¯¯ç±»å‹

```typescript
import { DatabaseError } from "pg";

async function handleDatabaseOperation() {
  try {
    const result = await db
      .insert(user)
      .values({
        id: crypto.randomUUID(),
        name: "æµ‹è¯•ç”¨æˆ·",
        email: "test@example.com",
      })
      .returning();
    
    return result;
  } catch (error) {
    if (error instanceof DatabaseError) {
      switch (error.code) {
        case "23505": // å”¯ä¸€çº¦æŸè¿å
          throw new Error("é‚®ç®±å·²å­˜åœ¨");
        case "23503": // å¤–é”®çº¦æŸè¿å
          throw new Error("å…³è”æ•°æ®ä¸å­˜åœ¨");
        case "23502": // éç©ºçº¦æŸè¿å
          throw new Error("å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º");
        default:
          throw new Error("æ•°æ®åº“æ“ä½œå¤±è´¥");
      }
    }
    throw error;
  }
}
```

### 2. é‡è¯•æœºåˆ¶

```typescript
async function withRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  let lastError: Error;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await operation();
    } catch (error) {
      lastError = error as Error;
      
      // å¦‚æœæ˜¯è¿æ¥é”™è¯¯ï¼Œç­‰å¾…åé‡è¯•
      if (error instanceof Error && error.message.includes("connection")) {
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        continue;
      }
      
      // å…¶ä»–é”™è¯¯ç›´æ¥æŠ›å‡º
      throw error;
    }
  }
  
  throw lastError!;
}

// ä½¿ç”¨ç¤ºä¾‹
const users = await withRetry(() => 
  db.select().from(user).limit(10)
);
```

## æœ€ä½³å®è·µ

### 1. æ•°æ®åº“è®¾è®¡åŸåˆ™

- **ä½¿ç”¨æœ‰æ„ä¹‰çš„è¡¨åå’Œå­—æ®µå**
- **ä¸ºå¤–é”®æ·»åŠ é€‚å½“çš„çº¦æŸ**
- **ä½¿ç”¨æ—¶é—´æˆ³å­—æ®µè®°å½•åˆ›å»ºå’Œæ›´æ–°æ—¶é—´**
- **ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•**
- **ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**

### 2. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

```typescript
// âœ… å¥½çš„åšæ³•ï¼šåªé€‰æ‹©éœ€è¦çš„å­—æ®µ
const users = await db
  .select({
    id: user.id,
    name: user.name,
  })
  .from(user);

// âŒ é¿å…ï¼šé€‰æ‹©æ‰€æœ‰å­—æ®µ
const users = await db.select().from(user);

// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨åˆ†é¡µ
const users = await db
  .select()
  .from(user)
  .limit(20)
  .offset(page * 20);

// âŒ é¿å…ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®
const users = await db.select().from(user);
```

### 3. å®‰å…¨è€ƒè™‘

```typescript
// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆDrizzle è‡ªåŠ¨å¤„ç†ï¼‰
const user = await db
  .select()
  .from(user)
  .where(eq(user.email, userEmail));

// âŒ é¿å…ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå®¹æ˜“ SQL æ³¨å…¥ï¼‰
// const query = `SELECT * FROM user WHERE email = '${userEmail}'`;

// âœ… éªŒè¯è¾“å…¥æ•°æ®
const validatedData = userSchema.parse(inputData);

// âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
await db.transaction(async (tx) => {
  // å¤šä¸ªç›¸å…³æ“ä½œ
});
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. å¯ç”¨æŸ¥è¯¢æ—¥å¿—

```typescript
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";

const client = postgres(databaseUrl, {
  debug: process.env.NODE_ENV === "development",
});

const db = drizzle(client, { 
  schema,
  logger: process.env.NODE_ENV === "development",
});
```

### 2. æ€§èƒ½ç›‘æ§

```typescript
// æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ç›‘æ§
async function monitorQuery<T>(
  queryName: string,
  query: () => Promise<T>
): Promise<T> {
  const start = Date.now();
  try {
    const result = await query();
    const duration = Date.now() - start;
    console.log(`Query ${queryName} took ${duration}ms`);
    return result;
  } catch (error) {
    const duration = Date.now() - start;
    console.error(`Query ${queryName} failed after ${duration}ms:`, error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const users = await monitorQuery(
  "getUserList",
  () => db.select().from(user).limit(10)
);
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ `DATABASE_URL` é…ç½®
   - ç¡®è®¤æ•°æ®åº“æœåŠ¡è¿è¡ŒçŠ¶æ€
   - éªŒè¯ç½‘ç»œè¿æ¥

2. **è¿ç§»å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æƒé™
   - ç¡®è®¤ schema è¯­æ³•æ­£ç¡®
   - æŸ¥çœ‹è¿ç§»æ—¥å¿—

3. **æŸ¥è¯¢æ€§èƒ½é—®é¢˜**
   - æ·»åŠ é€‚å½“çš„ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶
   - ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢è®¡åˆ’

### è°ƒè¯•æŠ€å·§

```typescript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
const db = drizzle(client, {
  schema,
  logger: {
    logQuery: (query, params) => {
      console.log("SQL:", query);
      console.log("Params:", params);
    },
  },
});

// ä½¿ç”¨ .toSQL() æŸ¥çœ‹ç”Ÿæˆçš„ SQL
const query = db
  .select()
  .from(user)
  .where(eq(user.email, "test@example.com"));

console.log(query.toSQL());
```

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ åº”è¯¥èƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨ vibetake ä¸­çš„ Drizzle ORM è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [Drizzle ORM å®˜æ–¹æ–‡æ¡£](https://orm.drizzle.team/)ã€‚